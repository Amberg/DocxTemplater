using System.Diagnostics;
using DocumentFormat.OpenXml;
using DocumentFormat.OpenXml.Packaging;
using DocumentFormat.OpenXml.Wordprocessing;
using OpenXml.Templates;
using Bold = DocumentFormat.OpenXml.Wordprocessing.Bold;
using Paragraph = DocumentFormat.OpenXml.Wordprocessing.Paragraph;
using Path = System.IO.Path;
using Run = DocumentFormat.OpenXml.Wordprocessing.Run;
using RunProperties = DocumentFormat.OpenXml.Wordprocessing.RunProperties;
using Text = DocumentFormat.OpenXml.Wordprocessing.Text;

namespace OpenXml.Templates.Test
{
    internal class DocxTemplateTest
    {
        [Test]
        public void ReplaceTextBoldIsPreserved()
        {
            using var memStream = new MemoryStream();
            using var wpDocument = WordprocessingDocument.Create(memStream, WordprocessingDocumentType.Document);

            MainDocumentPart mainPart = wpDocument.AddMainDocumentPart();
            mainPart.Document = new Document(new Body(new Paragraph(
                new Run(new Text("This Value:")),
                new Run(new RunProperties(new Bold() { Val = OnOffValue.FromBoolean(true) }), new Text("{{Property1}}")),
                new Run(new Text("will be replaced"))
            )));
            wpDocument.Save();
            memStream.Position = 0;
            var docTemplate = new DocxTemplate(memStream);
            docTemplate.AddModel("Property1", "Replaced");
            var result = docTemplate.Process();
            Assert.IsNotNull(result);
            result.Position = 0;

            var document = WordprocessingDocument.Open((Stream) result, false);
            var body = document.MainDocumentPart.Document.Body;
            // check that bold is preserved
            Assert.That(body.Descendants<Bold>().First().Val, Is.EqualTo(OnOffValue.FromBoolean(true)));
            // check that text is replaced
            Assert.That(body.Descendants<Text>().Skip(1).First().Text, Is.EqualTo("Replaced"));
        }

        [Test]
        public void BindCollection()
        {
            using var memStream = new MemoryStream();
            using var wpDocument = WordprocessingDocument.Create(memStream, WordprocessingDocumentType.Document);

            MainDocumentPart mainPart = wpDocument.AddMainDocumentPart();
            mainPart.Document = new Document(new Body(
                new Paragraph(
                    new Run(new Text("{{PropertyInRoot}}")),
                    new Run(new Text("This Value:")),
                    new Run(new Text("{{#ds.Items}}"), new Text("For each run {{ds.Items.Name}}"))
                ),
            new Paragraph(
                    new Run(new Text("{{ds.Items.Value}}")),
                    new Run(new Text("{{#ds.Items.InnerCollection}}")),
                        new Run(new Text("{{ds.Items.Value}}")),
                        new Run(new Text("{{ds.Items.InnerCollection.Name}}")),
                        new Run(new Text("{{ds.Items.InnerCollection.InnerValue}}")),
                    new Run(new Text("{{/ds.Items.InnerCollection}}")),
                    new Run(new Text("{{/ds.Items}}")),
                    new Run(new Text("will be replaced"))
                )
            ));
            wpDocument.Save();
            memStream.Position = 0;
            var docTemplate = new DocxTemplate(memStream);
            docTemplate.AddModel("ds",
                new {
                        PropertyInRoot = "RootValue", 
                        Items = new[]
                        {
                            new {Name = " Item1 ", Value = " Value1 ", InnerCollection = new[]
                            {
                                new {Name = " InnerItem1 ", InnerValue = " InnerValue1 "}
                            }},
                            new {Name = " Item2 ", Value = " Value2 ", InnerCollection = new[]
                            {
                                new {Name = " InnerItem2 ", InnerValue = " InnerValue2 "},
                                new {Name = " InnerItem2a ", InnerValue = " InnerValue2b "}
                            }},
                        }
                });
            var result = docTemplate.Process();
            Assert.IsNotNull(result);
            result.Position = 0;

            var document = WordprocessingDocument.Open(result, false);
            var body = document.MainDocumentPart.Document.Body;
            //check values have been replaced
            Assert.That(body.InnerText, Is.EqualTo("RootValueThis Value:For each run  Item1  Value1  Value1  InnerItem1  InnerValue1 For each run  Item2  Value2  Value2  InnerItem2  InnerValue2  Value2  InnerItem2a  InnerValue2b will be replaced"));
        }

        [Test]
        public void BindCollectionToTable()
        {
            var xml = @"<w:tbl xmlns:w=""http://schemas.openxmlformats.org/wordprocessingml/2006/main"">  
                      <w:tblPr>  
                        <w:tblW w:w=""5000"" w:type=""pct""/>  
                        <w:tblBorders>  
                          <w:top w:val=""single"" w:sz=""4"" w:space=""0"" w:color=""auto""/>  
                          <w:left w:val=""single"" w:sz=""4"" w:space=""0"" w:color=""auto""/>  
                          <w:bottom w:val=""single"" w:sz=""4"" w:space=""0"" w:color=""auto""/>  
                          <w:right w:val=""single"" w:sz=""4"" w:space=""0"" w:color=""auto""/>  
                        </w:tblBorders>  
                      </w:tblPr>  
                      <w:tblGrid>  
                        <w:gridCol w:w=""10296""/>  
                      </w:tblGrid>
                       <w:tr>  
                        <w:tc>  
                          <w:p><w:r><w:t>Header Col 1</w:t></w:r></w:p>  
                        </w:tc>
                        <w:tc>  
                          <w:p><w:r><w:t>Header Col 2</w:t></w:r></w:p>  
                        </w:tc>  
                      </w:tr>  
                      <w:tr>  
                        <w:tc>  
                          <w:tcPr>  
                            <w:tcW w:w=""0"" w:type=""auto""/>  
                          </w:tcPr>  
                          <w:p><w:r><w:t>{{#Items}}</w:t><w:t>{{Items.FirstVal}}</w:t></w:r></w:p>  
                        </w:tc>
                        <w:tc>  
                          <w:tcPr>  
                            <w:tcW w:w=""0"" w:type=""auto""/>  
                          </w:tcPr>  
                          <w:p><w:r><w:t>{{Items.SecondVal}}{{/Items}}</w:t></w:r></w:p>  
                        </w:tc>  
                      </w:tr>  
                    </w:tbl>";

            using var memStream = new MemoryStream();
            using var wpDocument = WordprocessingDocument.Create(memStream, WordprocessingDocumentType.Document);
            MainDocumentPart mainPart = wpDocument.AddMainDocumentPart();
            mainPart.Document = new Document(new Body(new Table(xml)));
            wpDocument.Save();
            memStream.Position = 0;
            var docTemplate = new DocxTemplate(memStream);
            docTemplate.AddModel("ds",
                new
                {
                    Items = new[]
                    {
                        new {FirstVal = "CC_11", SecondVal = "CC_12"},
                        new {FirstVal = "CC_21", SecondVal = "CC_22"},
                    }
                });
            var result = docTemplate.Process();
            Assert.IsNotNull(result);
            result.Position = 0;
            //  result.SaveAsFileAndOpenInWord();
            var document = WordprocessingDocument.Open(result, false);
            var body = document.MainDocumentPart.Document.Body;
            var table = body.Descendants<Table>().First();
            var rows = table.Descendants<TableRow>().ToList();
            Assert.That(rows.Count, Is.EqualTo(3));
            Assert.That(rows[0].InnerText, Is.EqualTo("Header Col 1Header Col 2"));
            Assert.That(rows[1].InnerText, Is.EqualTo("CC_11CC_12"));
            Assert.That(rows[2].InnerText, Is.EqualTo("CC_21CC_22"));
        }

        [Test]
        public void ProcessBillTemplate()
        {
            using var fileStream = File.OpenRead("Resources/BillTemplate.docx");
            var docTemplate = new DocxTemplate(fileStream);
            docTemplate.AddModel("ds", new
            {
                CompanyLogo = Convert.FromHexString(
                    "89504E470D0A1A0A0000000D49484452000000EC00000035080600000042E207F3000000017352474200AECE1CE90000000467414D410000B18F0BFC61050000000970485973000017110000171101CA26F33F00001D1949444154785EED5D09941D5599BEA3CEB8CF883AE2382A0C6EC338B82FB88D3A87711D1DC5051457703B2EB8939880014508921020A1937EB5BC5ED24D1283104ED81413911D4342309074BFBA55AFBBB3900508010909246FBEEFAF5BFDEABD57F55EBD5E92A8F59D73CFEBAEE5D6BDB7EE77EFFFFFF7BF7FA91C39721C0058DE1B95EDFF5AD9DE6EA4FDCAF16F5296FE885A5279B2B922478E1C8704DCF21B40D040756FACE0374C5D23151C7F4839FA5B6A46E549E6CA1C39721C54544046572FAB21EB28698749DA9D9879BF63AECE9123C741C59C35CF016177293768246C44DA62799772CAA79A3B72E4C871D0D0BDF179D05577A7129689A475FC3FABCEC1EFE28EBF0B6FCC9123C781C78C75FFA02CFF6E43CAF424E78347F0F7A9B9212A478E8389823E49B943BB5571A891A8F1C4F345E8B456E9DBB9212A478E8385CE557F0F124E8758FC684BD2863A2D48EB7FDDDC9D23478E038E25108D6DEF7488BD8F6522AD13EC5476E9ABE6EE1C39721C1458835395ED3FA2DC72450C5169A95BD66977A9E2C85755A51233442DB8F75F5A2667F09F5531789AB9233B7ABC17A805E5E43CE38996B4192B9F62EE6A0D8E56963E5CF2B6D7BF08E9D9E64C88D9C34F57F6D08B46F3B7B7D79E6F86DEC17F943C99379F515F6FE625E763E5CF92780FF3CE02B687337494B282A3953570B472068E529D1B9E6FCE2683EDC7F7C436CFAAFFB03C2C5BE7A6679823CD71F5E053A54D92CAC277D04E5E44C7D061AA50FE37A92353D7E0CBA4FC6345E7A6E7AB05C823CA8FED660D3FD79C9D38B0DC8EFF5AB4C55BDA4AAE7EB3FC16BCDFA8C26005ED989006C2DF8E7515B467455D72F74E75F12A92D6BC53DBFF43EBA4AF558E2E283BF88674A22CA0A5CBF62F43BAB136AF84E4F8CB5571F802C8F927A8B9F73ECFE4900E6BE43528CB1518816EC47D37E3BEAF9833212CFD1A8814CB3052DD28C9F6CF36679A831DD809662A77E816C9DBF1962AB7F4127316A498F12434F63720D2DCDC50875689F738DEF74C4EC96027B0F534FC5E8FDFCD487B9076236D44FA1D8E9F212F3D097D3B0F43BD2F54EEF0F56AFEC0BF9AA3CDE1FA17A0FDD03EC197CC91E670FDFF43195662109B6E8E54E106274B3D794D2B58A597A33E3F405E57E19E6165D15D0FF574F416FC8FF278E7E0F7BFCCD5AD610FBE3E6C9BF20AB4C11624E6F7A8B49B135C877CA78B6BE044A08BC41BBA1CCFDBABFAEEABA885634845CCAE17AFAEA8F37F5F51BF5C89C45F24FE7FDE8A8A3AEBCA8A9AD65F51A77557D4F44B2B6AC6E53BD4E9BF3A399C69E981D12AF56C0A1FC4BFDDF25A71A76A859595A7A0C1B6A9DE2D8DF9D527E6DFB7B582EB9F40BA16B2FBDB4C2EC9E8F4DF8D323C2065BAF47ECAFDE79833213A304ADBDEEFE51CF375F406BCC4C3CDD974D8DE9BF0FCADA30D4B7F4F1A0C222C59F264107696EADF9E5C8F66E9D21D2CC77C9353230A035F02A907A42D1C7D2B4874113AFF0C10F42CB9CF0E6E9332750D0D4BE7AC9F39421DC952BFDA85761C7C9F399A8EF330235A783F8B1FACE0F752751166CF56B04A73E47A37F8A63952855B3E5BEAE9949AF78D4EEF83B876B5EADD8C7CFCB5481D20D5996877D4D39F8BBADE101A5E8676A03EB344324903DF87E57F1162A327F9F17D39C185A80FF20B7E86FFE723AD9236ED1A0E54A1344DCD5BF72C7377FBE8C140C3BEB4107D8A626B92FE9935D948F3D680A4375413C93BE3F28A9ADA6BD2C2F0771A483BAD7F879ADAFF018EEAD54C447EA66C9D96705E3A5479B774A4660809BBB1AA6037C99B234EF4371BDED27801E537989C1A51187A17F2BC4F5E2C070447FFDC9CA9C22ACD54DD28AB3C3F780833E509E64C3A38D3C88B9797B10F8DFA2373268474103D336C83A8CD62656F964836D79F6772AA45417F126DF510A4976DE8549F16D1322ED672D0E88588EEFAEF47D96E17FDC6F14F3367AB70BC534D7BCCACD57B126007EFC5758FAA1EE9E86B316BFEBB39938CDE1D903EF432D58BBA2749596E40C2A123420249036739D7DF866B776250F986482FEC2711289551247686DEA9ECF2D5420CCEB61C8C9260973E8A77412FA10022F0F178378737B41BA50DCBFB1066C555E82FFBD12FBE6DCEB607B6A7EDCD3003C3C42492762E483BEB0FE10C3B4A5612B52E4D5F8419B7F7862A61E98C6CE9EB51B9AF43BE3E45C44C26C7FF1A46B1D9E80C1BD0D8FBA4F31569C5F21FC50B3CC554A71171C28A02AD6F93C6B2F5C9D5BCF11CA7FC2D74D22EE4B75D88CBB2901014015755AAB35B1C5908CB91DC0601788DE4E7CD35679241DDCBF1164A07E6C0647B8F881E19473D616D1D7680787BA526B4AB1D344A0ED4071DBD12CFDC8F0EF85E73341DECD0F43D8D8BEA11783FDBC5F56F97B23683ED9D8B6BF722AF113C7BAF2A7A1F3667924135C3F63D94D557973FF81C73B48A5684A53A6179BF459B418AF25B5B3F2941D810B38BC1EBC096C6C1E722AA2FFE7AD4F5FE4C12056D1A744AE85CF75273A43DD04660E33D457D7422D35C88C742D604A2C6D394DE7D55C2B21352074A335874EA7F02E92E02B131BBA2D02109EE483512C409CB51C9F6FA546725DD20C1D1D709D60AB9C3591923A7FF6973B61659084B1F4E1B1D97621A496879378A21290D0B371F81E76F1D9D116D5C5F8FC619765FD33A65810DA2B890009C60A974EAF140C88C81D1F67737B505483D503F47A3B397BE2322BE5BFE51D359D90E3E266D69F94EA2F8DC8AB00BBC63707E179E7B475B06C6341483F7E09DF1BD3AE6C8E4A2223699DF5625C6094822567BD0675755D499CB92491A4FA72DDC534B581B84EC4C99D5085A026D7D598C549885BCCF98B3B56820ACEE6F69AD157DA4FC88DC4332DAFE2C73A61659084B38FA62E4B74F24028A619DC107CD994658DEF1A10E86B660FDEC043D2D89B0ED58A093C0D992FA6DB13C316B6E96B758A425A7495DDD9157C84C697BB78716556F1BCA711548D038731224B2533E4DFDEA21B4A3F74573B416AD08EB049FC1331FC5F964B5A05D58A51F8AC46705DF3747261F96FEE18489C442560DB2DE69F457241A9BA6F6212588C51489A72E5CDE1E6109CB3F01D73D2CA2C1429085C682248C89B05CC680E84DE2C83DBE6BCED4222B612922D694359866CE34C2D197868390E8AF0FABF9DE2BCC992A2687B053422204C79B23E3830BBD9B22AEED5D608E34C2F6BE84E73E8674AE510596E29E5D8975265847C75FAA7A205D39036F35476BD18AB0F4DC114B7029F95DB50B1BCFB3FD3D1336D06501F5615BDF1CF639E927E34820EB5C43565A87CFA71E1B91B68EACB4184F5D380C1DF6D83110769896B2B290458C02BE9528E28C89B062EEBF27242C1A85BA6D12B212562CA7FE809441EA0791866B95F5A0B86FE91D32EA89D8E72D4FB4264E0661A9C3F76386E532C744807AB2AD1F44D96E36471A41C983EFC4F2DE21FFBB7A9A5A843258A50FC8FFF52806474A7BDBFA4ED5AD9375C056842DFA9FC2FDBB318826BFD376217A3C06625A7E0F24D8479D21076DF86790969123A2BE9031E97D9246C91A4F202D7FCFBE0A245D1C92F5F425D46FB7A919CBCC801E659495B04BB63E4B66418A5D4216FF32E9F0F5180B61A927B9C1FD4244114F830BCD995A64252CE1E8F3AB7A294432B7D4687DA638ECF84FC8A849BDC8F1BE66CED42251876DC3512009B4D6DA3E9730EE18775E44CF96676296D5489B12757631E6D0F803BD395A1A724B5C5FDD8DBA5D9CA8475BE577C81299ED77A4F68F9622F1C05168FF07F03E4A18005E688E8E1D744008DFC3F20969B776C0098AEBDE7D904822278D2CA9A05F89F2BE166D740D888FC166B03159D1DF1BD096BC66609BEABCF744F364A06DC252F9D6EB42C2B27343F7E9DBD4E8F9524F5847F734DD36448F17DBBF46CA21A22946308ADF49688BB0FE5B91C291B0878300D790EB8C2B8EDF276273179E6BFBD0E7BC379933B548226C71EB0B65369E87812C2D35EB502498AD178BC8CE018AED305E38DE32693F477FD21CA942DA83CE05DE15781FE172496103DA5EAF918138C9A0E44077A33465E9F425915684256CBDC00CDE8BD1CEAF3247C7868BF63F15E5427FC13BA5ADC3F68F30670E5DB09F50BAE1E4203AACE15E52123B8ABF5D15EA6D44D10559094B58FA4F92A1DC43CB59C2881927AC3C5CDF04527C5E3A914DF1C82492927A97EDDF6A968BC2EB2D6F85ACFD25A11DC2D241C0D6EB8590CC9F0E15F14EC991D2D683929790061243DA73EB096B430F71FC25287B1F7E93935DEE475D669B1C92219E59FE4D6A1166313A15D8FE0C699B6270ACB2371F91E99DC4418F343780B8EE9D6B8E54C1B5E6D02A5CF50EE3CA808D7A500AA17B601C33F01E490CDB7B10D7A42F9F64212CD7491D8D019ECE2CC100F23B07E53911C7DE292E85B36F79BAB9321B68F370823B44A5E02F1D4A0A839FC4EF5B21F5BDB4C6E9E56083D2252518B70CB2A29D23DE2525F6452E491686125649A28BC64C58FDBB44D12B4E58E6CFF5B770D47FC4FC868951E4980F9D1C460BAB3D546A7C8E131164C15BFF2C9C5D91BFE53DA63A62EBAB2486A3774939991F67933434CEB0E1F349F4B4C4CE59F0874D0EE920515C7D1ECAB3432D7E806DF038CA328267ACC6EF75786E11E9FBCA4D310CC55128BD5AEA63EB2B6A966AB8999AEFB86BF8094813B5AE7A8E9E8A367F5CC81E07D51D473F8CE3B7C95A661AB21096E8D9F202D4633AAE1D518BE8350529C5A11BA6B71675FF2D8E2F94B2CC1F78ADB9A339B856EE946783B03B4DBBED413EC3F8BD13C7E8528B76F34E9D10C965ACA08465FB73F14E1E1FE5435A923E58DE82D4281D09A20B279BB09CE1A89746890462E1783C140FF6E3E5A193FA572A6B73737FE576084BB8B8DE2DEF93E7C8E856AEBACF514CEB1ED92FF5214122434C1292083B9A588784C4E759FE80C9A139A81B513C75F4FFA25C67A12C4BF17B0F5EF6E361F9FCBD38B7099D7B4AEA7A39515CF9345C731FAEFF93180923F03D399A03C06A5558FB627334845B7E3BEAB603B3D6327324046779B1278048490E0C11B21256807CDC8D2F41BDDE87B24C471DFB71DF5DB8FF31F32C8A8CF7A1FEBF503D773DD3DC940ECEA424A4F83AA32F70E9D1F6D64B3E5DCC2F08494C75E8537887071A45F4B7E2D013D2D71BFA4D2CF11DD3138C06BA5444178F95B0F48E6A25129328B6CCAC65245F92AD351A3574C2082BB24BD6F8488A566897B0D251FD5BA433F059965E21C74311ED1671AC08EB726D539FDA06C2EAFDA8C3B9483370FCCCC444E2B9E5B1B9C351E7A7A59B863E1ACBECF2E9E878619B5AA873DABBAA284A15F41EC3CCE87FD41CE56CF9E6D093CBBFA0C1B2CF1D4E8EBE17D70FA92B63CE209CEDD8F10B8353CC9164B445D83AB05D5917CE44940E6831B7BDD0AF9AEBB659FC9CE388DA8D3AA305494248EC6D0E270FD4E74082BBBD2831B69A59C927EAAC54119A22BA212B6139B25B5ED5E8E4D24A97B0DD2A4E5876125B2F527D4387C9FDF41A21E8485F847836BA9C529A9949EF6897B07C81DC2040C309096BEBEDCAD9CC2D831F40F943ABB403DDC20ACE347724A37186DD271DFD40A25BBF122FF66EA8100FA0BCC9CB3084E37F41F56F63DBFCD01CA1F8FF55B4D77EB47BF2EE1C1147E98DA4FFC71CE1B1EB91C703F87DB739928CF1103609342239FE0AE917B6FE84393A76D0906869CEBA7B30F81C6B8E4E3EC80D9998287119AED5277229D1C09484E8A6AC840D9DC03784640111D38C3471C28696C17EB198C651DC72242A33247909697C887B83AF3767D3D12E61098A4B6EF9616309DE83FFBF8E674F91FB5946DBDB011D2DD93A1C2189B0E35D871D0B2832F7818CDC4C90B64FD9DAF01A19289D525144E4303EEEAF712F669A91E40ECB0EE34077A6284A2CA1FE0A5DD3D1832D77B94C3461098ACC5CE6A31BE54488B296A66FFC5ECCE27DE6C8E483FD8306BB34C286FD7EAB5A9061738A20BA312B613BFC57A121439289B5CFB712C5D824C226756EEE558D2A13CEC47346971BD23016C216065F8C17768BEC36113D56DF8A3C964BBD455CF16E9599B8190E19C27273BB1E866EFC47353765FB19B7185275B1210DC9B28D58CB1F41BA36957CF4E4E10C64EBABE47FABF41EE87F8C4E7FB9FCDF0C934158FA43CB5643BD67422419D19BBDFBF1AED79A23930F317A06DDC606519BC4859406A684E5B75444376725ACF884426C1222922CFE4FCD995A6425EC3CE8BFDC374BD286E6EE8741C8579BB3C9180B6169E8B0BD8E906C7896ED816CE808AC3B9FCD8DE3AD70A810B697838F772706BB8154CFA3D0CB0B33F0D01318BDDF86D915FA2BC44BEAAF6960E7B2F46AB4CD80BAA4C4CE3D05757C1CEDD57CE33D311984A5EEEAE815A2C6300AC778213B7CBCFBD02E836D2F218D07B4EC3B7A9D2C2B92A44C625CA3612DC5D72015ED10560C13FE95A1F186622497665276D464252CC188725201948324E4CE9E6618136101DB3B51660C317271803033BBA31F1387F856386466D881A350E632EA7387EC9D4D83137C592DD9C97A7E16ED4FDF5BCEB02799B3C9E0002CFB9D83E33128F4483D5B0DA0C46410962495DD471858C712A2A81ED48B6DEF01CC78779923070EC5F54762B0ECC07BBB1713D3060C1C4B5577C276CB96083B9E21AC97BC3B86101F4A6F2EAE7D5C3A7A78FDEDA96B73ED1096BEAA2266E35A2191F7E7A68681B112965661D7BFA7463C9181C7BB39D396AF24C28E17740F2C0CBCCEFC970D76E963E22C60E9F94D454517EDE496199CBA883AAE471B6B351F6DDD0C858177896AC26D6B7474B7FC4D99ACB4AD084B63A25B7ABBF92F1B0AFEFBF17EB6A3DC37352C6349ECAD363B3CF776736384D36242984C508A69A57A3545D471D9F92DFD7B34CE77F1FB6D4974B0B6FCD340D60BF1F25649E716D1959DDCDFDDD4AAD50E6159014B4F95EB38F30989F41589BA313156C2124ED0353AC3B2DEA1759ACB2EE96B8C111A09BB1F2FFF0C746EB4518B24B19AF47126A7108B4136E6D7BD894B5CDF95E59856E81A7A1948B81A65D8A9ACE043E66832A8B78B87D9103736401AF07E63CEA483337601FAB11B6CC740BA0BEFB9DF9C698E5684651B748F6CC53567B43460110C0DC30DEF12AA076A581CF477A6EDA46B9831A06201CA9AC05D7F0CAEBD076DB757D903D9E3451D7288082B8DCD75C5BA44B99BC1A644FF215945CFDCA73AF5F79B8E14ED109660881299FD2271DB7F089DF923E66C2DC64358E649114BEA22A46DAD334768246C58D62C2934D05D62720A41F5C31AFC32DA1862FAF01E0C1CB4E21E97D801C50FD5FF023AF1DDF2FC4E6FB610BE19585E06CFA32B220717AE0BB702454FCEC8F4D20A25912F9833CDD18AB0C5E06310B5B7CA3BA3E1ABE07D3C71098FFD869B312C6E63937EE34A99E2E02C452708B7CC18BF0CB6D68FFCFEDB9CAD05D776691DB6218A5277CCD20687344890786267A84F1189E8BA264E0F832735F5B421A4E14D10360940469FDB26840D0D1E3F97EBF9CCB093256F736B1584AD1996203FDBDB22621FD7296DFF6A7488E48DDBF508097B7E4D10B6FAB64A4BE227EC370661633B16344457E86AE1762DE360E2FF0689EBA27D282F241FBD19E71F05A9776356FF6966AB29FDB4657987DBBA52F6B2D6831D5CDE1906343A32644196206C5D748A60BD38DBFBA80B0674865D713998A39E1242C6DB08F2D36D75AFEA2ACF49DC0916C119643FF8232426E647FD3C407B5D13B619F384C4689530AB4327E7BE68BBFCE3D4B0437F316000AE9609E23009C7B5CB56F1712370F6E5362E4659ECD9B4162F67A63A7F4B7337B3EEE06834FC55986DD6CA7D14E73AF53BCDD92A16F003B9B41E0E21EFCD2C5FEB288E71482853960BF7DAFEE7CDD1D6E0CC47D1B567635DFB64486C032748F7B2A193BD0463E3C0467744763E3D82FF1925D143FBFD117FCF1249A41DD0B0E1A2E3326E545A30B37AD0234A7C98E9265A179D310DB6FEA6D493BED9CDC07EE10C1D87EB7AA183DE8D7BE8F916D6D3E66410DC05825D82FABEC5DCD11C9432ECA14F41AFA774726F4DBBB9016350A1DD4AF4D11EDFEEA0BF31B4D6CD92C05977BC718EFE12B17225D409FF0899DD240A478610AD7F89E0BBA59EED94FF43EAD995319E721AA8628CB6DBC0D1AAFFBEBFCE76CB9123478E1C3972E4C89123478E1C3972E4C8916362E1F09316A58F8EA64E24C7FBB8625C9C7A4F235AF1E8C89C64B965D479F9AC421D6479C77F952AAEAB6E72EFB8FBB0F0B9BE792E7EB9F09DB61ECAA50C3A49777A27E2F9C798A38D605C5DFA3677EA4FA8F9C38D16476EB4675992D690793CFEE1255ECBAFE425817B52E39FCAE8D8F202D5E1FDA7F92F195C83EE8AD7D924B6B58D7BFF16ADE139C680708D6F267ECF41C73917C461048559CAF5BFD8E089E2EA9FE0BAABD4EC758D6B734240CF36FF55C1057E89BA10F35AE2DA2A3F2BE8E85FE29E7390E72F90E62ACBBB4ED903D56FBC9058DC31C2287BDC885D28FD4059A54B71EF1C21FD28E8F942174A6F39AE3F5D9EC7BCEABD74B827969E2EF5BEB11C98183522BE86187E5A31F96B73967F464DDEFCD8925D9A63FE4B861DBC1EF9DF8EB29D27750E235520F9B3D482F51F69181C73E4480417AE196A93EE5F5122C9EA17D939BB3ADE25E870C901D238533006513DE81A66F33BA43132305282152C1407EEE8998CDD235F67D3D7A92E333BD28D909F429CB7EEE5B2C6C601840BF90C781DFF760C2300328E0FF789B2DCB22D8BF15F3128581BAA319A5CCCD2050F65C1F3E210C2D22921E644C16BD3FC682D0C347422892012498B6FBC709072FCCBC5732BAA3313DB3A4B948D1C3904DC1BD8CACD9070318B38FA4274CCEFE1776AC33DDC41627B4BCC7F5584849D857BAA9B74494CCB2F2676543AA873360AFFC6EC8AD40CDCD748B224851171F55740AE9F98FF38387D1A84A5B750236139DB3BFA73E64878AD041E4B40289154838DB3EE8E6799FF92C160DCF4163B1841C072FC15210B61492C9781C606BE2641C349AAE29A5A7D5308AB1799FFAAE0CC1892A196B005DF6D100345DF651446A3A716B85B08834433707B1F3F645C0421EA2141BA6301A64942ABF4CBC44D0BFCA6EAA41336686C9F1C39DA023F9DC078B5242D7D65991A664FF9B6E6F2D1D09874D6E68C1B073FF74022BBC3C760067B9D2467046269F036DC5BC4F5D58F3D31560FC94D32D1B8D3AF0F0791F8CD9E99204337C4C7D0E19BF183E5434DFE3C65973F2CE169E8B617C7FCF547820805DCD7DAF7943A2A078A4270EC681999BABC37AA827651A6EAE6EE89266CD80E901EBC37E1F9E173A95A307C4B6E70CA9119E1EE10065CBE069DE95A74DCEBD1713BD5CA98D868973F814E59FD8811754B7E7A230EB178EA41E8A6178218732531D2B9A50B78C6AD723E8215BC07E74BB87E11C8D88BE75D8D67AFC5358C8A50FBC905FE4FE77EE6C5D8428E7733AEFBCE68648C1E7EE203E56D16783C02ADC7DC5050C0F5511925791D387E2B74F0CF9A2B279EB074A8A734C367F1730D61FBA06DF4296A55AEC3E6C80A7E559B861CCE6A4CF221E4F5CF16CB6B041A5F485ACEC40C9046830FC3931446AAC1A84391F832D93D114F73373E0F1D13BA6F4C24EE1AC20C1BF42A6BDD7325922267654BDF00D2A54724A02189D7F63100997705C4E6F03BA524B4E5DB2050EBAD632212EB3998B90FAB2963B8E5EE0294B15624E68E922490B0FCA27A84CC22B17F99B46DF4DCCE55CFC8BC8326470E412B1D360CDF3202B1F34CFC4E41A79E2ADBC46CEF3659668920844D303AC9B24E06A313F3B5BC8B33756037F810F2B465CFAD7C75DCB7707FE3363C0E08913E4C9084343AD52FEB5024AD373A8503D062F35F15DC4144725BA5EAB769B21336373AE5182748D824234C045A59198C8BEBB2F2216024FEEDFA8C427FA5CC14441A619B5989E3E4A4430645E3F8A732381BF12B65F5A03ECC355F8AC5CC8322B11D9C6CCE56E1F2A352FA67E6BF2A61B358891985420280D56DBAE7F765F9F1E7F887A172C2E6386068465892D181A8CA35CD7A700D959FE78F42738C97B004070117FA5D44280B622FBFC2DEB9A1BA693B149FAFC5B5278C8AED8C546F05D7D518C28AFA243C73850C0411DA216CF8D536E89A20222DE30437EF879F0B9C1FAA0D06AC3B8396311F26067493843C22E92524EC521C0F837AC7AF490A09932347222C6F4DEAA8CFCF33D0F012EF9C1142D1F0C7E8C0D3E57F5A716DDD2D7FC7413DCDF6CE964E1DA1531F0722753410568286F9A1A59960306C9B9FA26470388F512B5623F14B6E9F1B353A1152164689F77F2DD7D9FE9D98F11872A4F60B6D8C15C4C0E54984E54C5CFF5D137E5A84F5E3D7CC1D7F0DF2661897331BA26E7495DE8BBCB7A88294EF4EFC8D5F24468E28E853E41A7E52B2E0F143566B6AAFF1F83D9B1F097173E4680AA5FE1FC1330A4638A1544F0000000049454E44AE426082"),
                DisplayName = "John Doe",
                Street = "Main Street 42",
                City = "New York",
                Bills = new[]
                {
                    new
                    {
                        Date = DateTime.Now,
                        Name = "Rechnung für was",
                        CustomId = "R1045",
                        Amount = 1045.5m,
                        PaidAmount = 0m,
                        OpenAmount = 1045.5m
                    },
                    new
                    {
                        Date = DateTime.Now,
                        Name = "Bill 2",
                        CustomId = "R4242",
                        Amount = 1045.5m,
                        PaidAmount = 5042m,
                        OpenAmount = 1045.5m
                    },
                },
                Total = 1045.5m,
                TotalPaid = 0m,
                TotalOpen = 1045.5m,
                TotalDownPayment = 0m
            });

            var result = docTemplate.Process();
            var document = WordprocessingDocument.Open(result, false);
            var body = document.MainDocumentPart.Document.Body;
            var paragraphs = body.Descendants<Paragraph>().ToList();
            Assert.That(paragraphs.Count, Is.EqualTo(60));
            // check some replacements
            Assert.That(body.InnerText.Contains("John Doe"), Is.EqualTo(true));
            Assert.That(body.InnerText.Contains("Main Street 42"), Is.EqualTo(true));
            Assert.That(body.InnerText.Contains("New York"), Is.EqualTo(true));

            // check table
            var table = body.Descendants<Table>().First();
            Assert.That(table.InnerText.Contains("Rechnung für was"), Is.EqualTo(true));
            Assert.That(table.InnerText.Contains("R1045"), Is.EqualTo(true));
            Assert.That(table.InnerText.Contains("Bill 2"), Is.EqualTo(true));
        }
    }


}
